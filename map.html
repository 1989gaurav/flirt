<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>

    <!-- <script src="../facebox/facebox.js"></script> -->
    <link href="css/jquery-ui.css" rel="StyleSheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="css/map.css" />
    <link rel="stylesheet" href="css/example.css">
    <link rel="stylesheet" href="css/stroll.css">
    <!--<link rel="stylesheet" href="../facebox/facebox.css"> -->
    <style>
        #container {
            /*background:#ffffff url('images/carpet.jpg') repeat 0 0;*/
            background-color:#225D82;
            height:480px;
            width:800px;
        }

        .table {
            position:absolute;
        }

            /*TODO : change position*/
        #chat_box {
            position:absolute;
            top:100px;
            left:200px;
        }

        .tableImage {
            background:#ffffff url('images/table.jpg') repeat 0 0;
            width:160px;
            height:80px;
            position:absolute;
            -moz-border-radius: 5px;
            border-radius: 5px;
        }

        #tableImage1 {
            top:130px;
            left:130px;
        }

        .chair {
            width:20px;
            height:20px;
            position:absolute;
            background-image: url('images/chair-light.png');
            cursor:pointer;
        }

        .offline {
            width:20px;
            height:20px;
            position:absolute;
            background-image: url('images/chair-dark.png');
        }

        .chair:hover {
            background-image: url('images/chair.png');
        }

        .reverse {
            -webkit-transform: rotate(180deg);
            -moz-transform: rotate(180deg);
            -ms-transform: rotate(180deg);
            -o-transform: rotate(180deg);
            transform: rotate(180deg);
        }
.ui-widget-overlay {
opacity: 0.8;
}
    </style>
    <script>
        $(document).ready(
                function() {
                    addTable(90, 110, 500, 30, "tableId");
                    addTable(90, 140, 40, 30, "table3");
                    addTable(90, 140, 40, 340, "table4");
                    addTable(90, 110, 40, 180, "table2");
                    addTable(90, 140, 500, 350, "table6");
                    addTable(90, 300, 200, 180, "table7");
                    addTable(90, 140, 270, 50, "table8");
                    addTable(90, 110, 550, 180, "table9");
                }
        );

        function addTable(height, width, left, top, tableId) {
            $("#container").append("<div class='table' id='table_" + tableId + "'></div>");
            $("#container").append("<div class='tableImage' id='tableImage_" + tableId + "'></div>");
            $("#tableImage").css("width", (width-30) + "px");
            $("#tableImage_" + tableId).css("height", (height-60) + "px");
            $("#tableImage_" + tableId).css("width", (width-60) + "px");
            $("#tableImage_" + tableId).css("top", (top+30) + "px");
            $("#tableImage_" + tableId).css("left", (left+30) + "px");


            $("#table_" + tableId).css("width", width + "px");
            $("#table_" + tableId).css("height", height + "px");
            $("#table_" + tableId).css("top", top + "px");
            $("#table_" + tableId).css("left", left + "px");

            for (i= width-65; i>10; i = i - 30) {
                var chairId = "chair_" + tableId + "_" + i + "a";
                $("#table_" + tableId).append("<div class='reverse " + getClassForOnline()+ "' id='" + chairId +"'></div>");
                $("#" + chairId).css("left", i + 15 );
                //$("#" + chairId).css("left", width );

                var chairId = "chair_" + tableId + "_" + i + "b";
                $("#table_" + tableId).append("<div class='" + getClassForOnline()+ "' id='" + chairId +"'></div>");
                $("#" + chairId).css("left", i + 15 );
                $("#" + chairId).css("top", height-20 );
            }
            $('#chair_table3_75a').addClass("chair").removeClass("offline");
            $('#chair_table2_45b').addClass("chair").removeClass("offline");
        }

        function getClassForOnline() {
            var random = Math.random()*10;
            if(random<2) {
                return "offline";
            }
            return "chair";
        }
    </script>
    <title></title>
</head>




<body>

<div  id="drinks_menu" style="display: none; overflow:flow;">
    <table class="menu_table">
        <ul >
			<li>Mojito</li>
			<li>Long Island Ice Tea</li>
			<li>Purple Haze</li>
			<li>Bloody Mary</li>
			<li>Piscola</li>
			<li>Screw Driver</li>
			<li>Greyhound</li>
			<li>Margarita</li>
			<li>Tequila Sunrise</li>
			<li>Pink Lady</li>
			<li>Sex on the beach</li>
		</ul>
    </table>
</div>
<div id="songs_menu" style="display: none; overflow:flow;">
    <div >
        <ul >
			<li></li>
			<li>Evanescence - Lithium</li>
			<li>Enrique Iglesias - Hero</li>
			<li>Jet - Are You Gonna Be My Girl?</li>
			<li>Linkin Park - Numb</li>
			<li>Parammore - Ignorance</li>
			<li>Baha Men - Who let the dogs out</li>
			<li>Seether - Broken</li>
			<li>Shinedown - Bully</li>
			<li>Nickelback - Far Away</li>
			<li>Daughtry - Home</li>
			<li>3 Doors Down - Kryptonite</li>
		</ul>
    </div>
</div>

<div  id="food_menu" style="display: none;top: 0; left:0; ">
    <div >
        <ul ><li>Some Food</li><li>Some Food</li><li>Some Food</li><li>Some Food</li><li>Some Food</li><li>Some Food</li><li>Some Food</li><li>Some Food</li></ul>
    </div>
</div>
<div id="container">
</div>
</body>


<div id="chair_menu" class="chair_menu" style="display: none">
    <table class="menu_table">
        <tr>
            <td><div id="poke" class="menu_item" title="Poke"><img src="./images/ping.png" alt="Send Message" height="50px" width="50px"></div></td>
            <td><div id="chat" class="menu_item" title="Chat"><img src="./images/message.png" alt="Send Message" height="50px" width="50px"></div></td>
            <td><div id="buy_drink" class="menu_item" title="Buy Drink"><img src="./images/drink.png" alt="Send Message" height="50px" width="50px"></div></td>
            <td><div id="dedicate_song" class="menu_item" title="Dedicate Song"><img src="./images/song.png" alt="Send Message" height="50px" width="50px"></div></td>
        </tr>
    </table>
</div>


<div id="chat_box" style="width:160px; display:none;">
    <div id="chat_box_top">
        <div id="chat_box_old_message">
            <div class="chat_me_box">Text</div>
        </div>
        <!-- <input id="chat_box_input" placeholder="input chat"/> -->
        <div id="chat_box_input" contenteditable="true"></div>
        <input type="submit" id="chat_box_input_button" value="Send"/>
    </div>

    <div id="chat_box_bottom">
    </div>

</div>


<script>
window.myId = "chair_table3_75a";
window.receiverId = "chair_table2_45b";

$(document).ready(function() {
    var pollInterval = setInterval(function() {
        pollForMessages(window.myId);
    }, 5000);

    $('div.chair').live("click",function(e){
        //window.receiverId = $(this).attr('id');
        $('div#chair_menu').dialog({
            modal: true,
            resizable: false
        });
        e.preventDefault();
        e.stopPropagation();
        return false;

    }); //close click

    $('body')
            .bind(
            'click',
            function(e) {
                if($('div#chair_menu').dialog('isOpen') && !$(e.target).is('.ui-dialog, a')
                        && !$(e.target).closest('.ui-dialog').length ) {
                    $('div#chair_menu').dialog('close');
                }

                if($('div#drinks_menu').dialog('isOpen') && !$(e.target).is('.ui-dialog, a')
                        && !$(e.target).closest('.ui-dialog').length ) {
                    $('div#drinks_menu').dialog('close');
                }

                if($('div#songs_menu').dialog('isOpen') && !$(e.target).is('.ui-dialog, a')
                        && !$(e.target).closest('.ui-dialog').length ) {
                    $('div#songs_menu').dialog('close');
                }

                $('#chat_box').hide();
            }
    );

    $('div.menu_item').mouseover(function(event){
        $("div.restaurantSelectMenu").removeClass("restaurantSelectMenu");
        $(this).addClass("restaurantSelectMenu");
    });

    $('div#poke').click(function(e) {
        if($('div#chair_menu').dialog('isOpen')) {
            $('div#chair_menu').dialog('close');
        }
        submitData("ping", window.myId, window.receiverId);

        e.preventDefault();
        e.stopPropagation();
        return false;
    });

    $('div#chat').click(function(e) {
        e.preventDefault();
        e.stopPropagation();
        if($('div#chair_menu').dialog('isOpen')) {
            $('div#chair_menu').dialog('close');
        }

        getData(window.myId, window.receiverId);
        //var conversationData = eval("({success:true, messages:[{time:'33:20 pm', msg:'first Ping', sent:'1'},{time:'33:21 pm', msg:'Second Ping', sent:'0'}]})");
        return false;


    });


    $("#chat_box_input_button").click(function(e) {
        var message = $("div#chat_box_input").html();
        submitData(message, window.myId, window.receiverId);
        e.preventDefault();
        e.stopPropagation();
        return false;
    });

    $("#chat_box").click(function(e) {

        e.preventDefault();
        e.stopPropagation();
        return false;
    });

    $('div#buy_drink').click(function(e) {
        if($('div#chair_menu').dialog('isOpen')) {
            $('div#chair_menu').dialog('close');
        }
        // window.open("menu.html?type=drinks_menu");
         $('div#drinks_menu').dialog({
            modal: true,
            resizable: false,
            position: {
                my: 'top',
                at: 'top'
            }

        });

        e.preventDefault();
        e.stopPropagation();
        return false;

    }); //close click

    $('div#dedicate_song').click(function(e) {
        if($('div#chair_menu').dialog('isOpen')) {
            $('div#chair_menu').dialog('close');
        }
        //window.open("menu.html?type=songs_menu");
        $('div#songs_menu').dialog({
            modal: true,
            resizable: false,
            position: {
                my: 'top',
                at: 'top'
            }
        });
        e.preventDefault();
        e.stopPropagation();
        return false;
    });

    $('li').mouseover(function(){
        $('.selectedLi').removeClass("selectedLi");
        $(this).addClass('selectedLi');
    });

    $('li').click(function(e){
        $("#songs_menu").css("display", "none");
        $("#drinks_menu").css("display", "none");
        e.preventDefault();
        e.stopPropagation();
        return false;
    });



    function submitData(message, myId, receiverId) {
        console.log(message);

        $.ajax({
            url: "http://akush.in/openhack2012/sendMessage.php",
            data: "sender="+myId+"&receiver="+receiverId+"&message="+message,
            success: function(data) {
                console.log("submitData: " + data);
                $("#chat_box_input").html("");
            },
            error : function() {

            }
        });

        var baap = $("div#chat_box_old_message");
        addNewMessage(message, 1,baap);
    };

    function getData(myId, receiverId) {

        $.ajax({
            url: "http://akush.in/openhack2012/getMessage.php",
            data: "sender="+myId+"&receiver="+receiverId+"&all",
            success: function(data) {
                console.log("getdata: " + data);
                if(data) {
                    renderConversation(data.messages);
                }
            },
            error : function(data) {
            },
            dataType: "json"
        });
    };

    function renderConversation(conversationData) {
        $('#chat_box').show();
        $('div#chat_box_old_message').empty();
        var baap = $("div#chat_box_old_message");
        if(!conversationData || conversationData.length == 0 ){
            // If conversation data is null, do nothing
            return;
        } else {
            // If conversation data is not null add divs
            var i;
            for(i=0; i<conversationData.length; i++) {
                if(conversationData[i].msg != "ping") {
                    addNewMessage(conversationData[i].msg, conversationData[i].sent, baap)
                }
            }
        }

    };

    function addNewMessage(message, sent, baap) {

        var conv_div = $("<div/>").html(message).appendTo(baap);

        if(sent == 1) {
            // I sent this one, so it will be Me
            conv_div.addClass("chat_me_box");
        } else {
            // Stranger sent this, so it will be stranger
            conv_div.addClass("chat_stranger_box");
        }
		baap.animate({scrollTop: baap.height()});
    };

    function pollForMessages(id) {
        $.ajax({
            url: "http://akush.in/openhack2012/getUpdates.php",
            data: "receiver="+id,
            success: function(data) {
                var i = 0;

                if(data) {
                    var messages = data.messages;
                    for(i=0; i<messages.length;i++) {
                        var curData = messages[i];
                        if(curData.msg == "ping") {
                            // type = 1 for ping
                            showMePingMessage(curData.sender);
                        } else {
                            // type = 2 for chat
                            showMeChatMessage(curData.sender, curData.msg);
                        }
                    }
                }
            },
            error : function(data) {
            },
            dataType: "json"
        });
    };

    function showMePingMessage(sender) {
        var message = "Someone from table 1 has poked you";
        console.log(message);

        var container = $("#container");
        $('<div/>').html(message).addClass("pokeNotification").appendTo(container);
        $("div#"+sender).addClass("unselectedVibChair");
        $("div#"+sender).removeClass("chair");
        window.vibrationTimer = setInterval(function(){
            var chair = $("div#"+window.receiverId);
            console.log(chair);
            if(chair.hasClass("selectedVibChair") ) {
                console.log("already selected, so un selecting");
                chair.removeClass("selectedVibChair");
                chair.addClass("unselectedVibChair");
            } else if( chair.hasClass("unselectedVibChair")) {
                console.log("not selected, so selecting");
                chair.removeClass("unselectedVibChair");
                chair.addClass("selectedVibChair");
            }
        }, 500);
    };

    $("div#"+window.receiverId).click(function(e){
        var notification = $("div.pokeNotification");
        if(notification) {
            notification.remove();
        }

        clearInterval(window.vibrationTimer);
        var chair = $("div#"+window.receiverId);
        if( chair.hasClass("selectedVibChair") || chair.hasClass("unselectedVibChair")) {
            chair.removeClass("selectedVibChair");
            chair.removeClass("unselectedVibChair");
            chair.addClass("chair");
            e.preventDefault();
            e.stopPropagation();
            return false;
        }

    });
    function showMeChatMessage(sender, message) {
        console.log("sender: "+sender+"message: "+message);

        var chat = $("div#chat_box");
        if(chat.css("display") == "none" ) {
            // fetch all and build conversation thing
            getData(window.myId, window.receiverId);
        } else {
            // just add the new one
            var baap = $("div#chat_box_old_message");
            addNewMessage(message, 0,baap);
        }

    };


});


</script>
</html>	